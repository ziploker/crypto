function numberWithCommas(number) {
    var parts = number.toString().split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return parts.join(".");
}

var howmuch = 0;
var symbols = [];
var howmanytimes = 0;


$( document ).ready( function() {
	
	 
	var count = $('#show_table tr').slice(1).length;
	
	$('#show_table tr').slice(1).each(function (i, row){
	    var sym = $(this).find("td:eq(1)").text();
	    var id = $(this).find("td:eq(0)").text();
		var num = $(this).find("td:eq(4)").text().replace("$", "").replace(",", "");
		
		var newnum = parseFloat(num);
		var q = $(this).find("td:eq(3)").text();
		var quantity = parseFloat(q);

		
		symbols.push(id,sym);
		
		whatsPrice(sym, id, newnum, quantity, count);

		if (i+1 === count) {

			
		};
	});


	

	function whatsPrice(tag, id, newnum, quantity, count){

		$.getJSON('https://min-api.cryptocompare.com/data/price?fsym='+tag+'&tsyms=USD', function(json){


			console.log(count);

			
			var currentnum = parseFloat(json.USD);
			currentNumUncut = currentnum.toFixed(2);
			
			//alert(quantity + " * "  +currentnum + " = " + parseFloat(quantity) * parseFloat(currentnum));
			var sum = parseFloat(quantity) * parseFloat(currentnum);
			
			howmuch = howmuch + sum;
			//alert(sum +"+"+howmuch );
			var profit = (currentnum - newnum);
			profit = profit.toFixed(2);

			currentnum = numberWithCommas(currentNumUncut);
			
			//alert(id+ " ==> "+currentnum);

			//$("#myTotal").empty().append("total = " + parseFloat(howmuch).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
			$("#"+id+"_current").append("$"+currentnum);
			
			$("#"+id+"_current_total").append("$"+parseFloat(sum).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));

			$("#"+id+"_profit").append(profit);
			
		}).done(function(){
			
			$.ajax({

				url: '/wallets/'+id,
				//datatype: 'json',
				type: 'PATCH',
				data: {"current_value": currentNumUncut},
				
				success: function(data) {
					//var data = JSON.parse(data);
					//alert(data);
				},


				failure: function() {

					//alert("unsuccesful");
				}

			});







			howmanytimes += 1;
			if (howmanytimes == count){
				$("#myTotal").append("total = " + parseFloat(howmuch).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
				//alert( $("#roomnumberToSave").text().trim() );

			};
		});
	
	};

	
	

	function showTotal(total){
		
		$("#myTotal").append("total = " + total);
	
	};
	

	function getTotal(){

		t = $("#myTotal").val().trim();
		//alert("t " + t)
		return t;
	};

});
